## TCP三次握手、四次挥手

#### TCP三次握手

- 第一次握手：建立连接。客户端发送连接请求报文段，将SYN设置为1、Sequence Number（seq）为x；接下来客户端进入SYN_SENT状态，等待服务端的确认。
- 第二次握手：服务器收到客户端的SYN报文段，对SYN报文段进行确认，设置Acknowledgment Number（ACK）为x+1（seq+1）；同时自己还要发送SYN请求信息，将SYN设置为1，seq为y。服务器将上述所有信息放到SYN+ACK报文段中，一并发送给客户端，此时服务端进入SYN_RCVD状态。
- 第三次握手：客户端收到服务端的SYN+ACK报文段；然后将ACK设置为y+1，向服务端发送ACK报文段，这个报文段发送完毕后，客户端和服务端都进入ESTABLISHED（TCP连接成功）状态，完成TCP的三次握手。

用通俗的语言描述：

```java
C：你能听到吗？
S：我能听到，你能听到吗？
C：我能听到，开始吧。
```

C 和 S 两方都要能确保：我说的话，你能听到；你说的话，我能听到。所以需要三次握手。

#### TCP四次挥手

当客户端和服务端通过三次握手建立了TCP连接以后，当数据传送完毕，断开连接时需要进行TCP的四次挥手。其四次挥手如下：

-  第一次挥手：客户端设置seq和ACK，向服务端发送一个FIN报文段。此时，客户端进入FIN_WAIT_1
  状态，表示客户端没有数据要发送给服务端了。
  
- 第二次挥手：服务端收到了客户端发送的FIN报文段，向客户端回了一个ACK报文段。

- 第三次挥手：服务端向客户端发送 FIN 报文段，请求关闭连接，同时服务端进入LAST_ACK状态。

- 第四次挥手：客户端收到服务端发送的FIN报文段，向服务端发送ACK报文段，然后客户端进入
  TIME_WAIT状态。服务端收到客户端的ACK报文段以后，就关闭连接。此时，客户端等待2MSL（最大报
  文段生存时间）后依然没有收到回复，则说明服务端已正常关闭，这样客户端也可以关闭连接了。

用通俗的语言描述：  

```java
A：我说完了
B：我知道了，等一下（等待确认结束，可能还没说完）
B：我也说完了
A：我知道了，结束吧
```

B 收到 A 结束的消息后 B 可能还没说完，没法立即回复结束标示，只能等说完后再告诉 A ：我说完了。

![三次握手四次挥手.png](https://i.loli.net/2020/01/07/aflEi9onFSvR7cs.png)