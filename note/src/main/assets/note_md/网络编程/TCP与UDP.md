

## TCP与UDP

###  TCP基本概念

Transmission Control Protocol **传输控制协议**，是一种面向连接的、可靠的、基于字节流的传输层通信协议，是面向连接的、可靠的流协议。流就是指不间断的数据结构，TCP 为了保证报文传输的可靠，就给每个包一个序号，同时序号也保证了传送到接收端实体的包的按序接收。然后接收端实体对已成功收到的字节发回一个相应的确认(ACK)；如果发送端实体在合理的往返时延(RTT)内未收到确认，那么对应的数据（假设丢失了）将会被重传。

- 发送缓存和接受缓存
  - 用来临时保存双向通信的数据。在发送时，应用程序将数据传送给TCP发送缓存后，就可以做自己的事情，TCP在合适的时候发送数据；在接受数据时，TCP把发送的数据放入缓存，上层应用在合适的时候读取缓存即可。
- 
  滑动窗口
  - TCP的滑动窗口以字节为单位，用3个指针进行表示。当窗口内连续报文段被确认收到后，可以将窗口向前滑动。窗口大小应小于等于缓存区的大小。
- 滑动窗口协议
  - 只有在接收窗口向前滑动时（与此同时也发送了确认），发送窗口才有可能向前滑动。收发两端的窗口按照以上规律不断地向前滑动，因此这种协议又称为滑动窗口协议。
    - 当发送窗口和接收窗口的大小都等于 1时，就是停止等待协议。
    - 当发送窗口大于1，接收窗口等于1时，就是回退N步协议。
    - 当发送窗口和接收窗口的大小均大于1时，就是选择重发协议。

### TCP的特点

- TCP是面向连接的传输层协议。
- TCP连接是点对点的（套接字--IP:Port到套接字）。
- TCP提供可靠交付的服务。
- TCP提供全双工通信。
- 面向字节流。

### TCP报文结构

报文结构如下所示

- 源端口、目的端口：16位长。标识出远端和本地的端口号。
- 序列号：32位长。表明了发送的数据报的顺序，不一定从0开始。
- 确认号：32位长。希望收到的下一个数据报的序列号，表明到序列号`N-1`为止的所有数据已经正确收到。
- TCP协议数据报头长：4位长。表明TCP头中包含多少个32位字。
- 接下来的6位未用。
- ACK：**ACK位置1表明确认号是合法的**。如果ACK为0，那么数据报不包含确认信息，确认字段被省略。
- PSH：表示是带有PUSH标志的数据。接收方因此请求数据报一到便可送往应用程序而不必等到缓冲区装满时才传送。
- RST：用于复位由于主机崩溃或其它原因而出现的错误的连接。还可以用于拒绝非法的数据报或拒绝连接请求。
- SYN：用于建立连接。
- FIN：用于释放连接。
- 窗口大小：16位长。窗口大小字段表示在确认了字节之后还可以发送多少个字节。
- 校验和：16位长。是为了确保高可靠性而设置的。它校验头部、数据和伪TCP头部之和。
- 紧急指针：`URG=1`时才有意义。
- 可选项：长度可变，最长40个字节。
  - MMS
  - SACK：选择确认。
  - 时间戳：计算往返时间；用于处理TCP序号超过`2^32`的情况，又称为防止序号回绕（PAWS）。

- TCP最小长度为20个字节。

### TCP连接建立

TCP是因特网中的传输层协议，使用**三次握手协议**建立连接。当主动方发出SYN连接请求后，等待对方回答 SYN + ACK ，并最终对对方的 SYN 执行 ACK 确认。这种建立连接的方法可以防止产生错误的连接，TCP 使用的流量控制协议是可变大小的滑动窗口协议。

### UDP基本概念

UDP 协议全称是（User Datagram Protocol）用**户数据报协议**，是 OSI（Open System Interconnection，开放式系统互联） 参考模型中一种**无连接的传输层协议**，提供面向事务的简单**不可靠信息传送服务**，在网络中它与 TCP 协议一样用于**处理数据包**，是一种**无连接的协议**。UDP 有不提供数据包分组、组装和不能对数据包进行排序的缺点，也就是说，当报文发送之后，是无法得知其是否安全完整到达的。UDP 用来支持那些需要在计算机之间传输数据的网络应用。包括网络视频会议系统在内的众多的客户/服务器模式的网络应用都需要使用 UDP 协议。

UDP 是不具有可靠性的数据报协议。细微的处理他会交给上层的应用去完成。在 UDP 的情况下，虽然可以确保发送消息的大小，确不能保证消息一定会到达。因此应用有时会根据自己的需要进行重发处理。
### TCP和UDP的区别

UDP协议：

- **面向无连接**
- 每个数据报的大小在限制在64k内
- 因为是面向无连接，所以是**不可靠协议**
- 不需要建立连接，**速度快**

TCP协议：

- 必须**建立连接**，形成传输数据的通道
- 在连接中可进行**大数据量传输**
- 通过三次握手完成连接，是**可靠协议**
- 必须建立连接，**效率会稍低**